<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fund NAV Chart</title>
  <!-- Load Highcharts -->
  <script src="https://code.highcharts.com/stock/highstock.js"></script>

  <!-- Load data generated from __MCI2.xlsx -->
  <!-- This file must define: navData and sp500EqualWeightCadData -->
  <script src="mci2_nav_data.js"></script>
</head>
<body>
  <!-- Container for the chart -->
  <div id="navChartContainer" style="width: 100%; height: 400px;"></div>

  <!-- JavaScript to create the chart -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Basic checks
      if (typeof navData === 'undefined' || !navData.length) {
        console.error("navData is not loaded. Check mci2_nav_data.js.");
        return;
      }

      if (typeof sp500EqualWeightCadData === 'undefined' || !sp500EqualWeightCadData.length) {
        console.warn("sp500EqualWeightCadData is not loaded or empty. Second series will not show.");
      } else {
        console.log("sp500EqualWeightCadData length:", sp500EqualWeightCadData.length);
      }

      // Helper: get starting value for a given data series
      function getStartValue(seriesArray, startDate) {
        for (let i = 0; i < seriesArray.length; i++) {
          if (seriesArray[i][0] >= startDate) {
            return seriesArray[i][1];
          }
        }
        // Fallback: first value in the series
        return seriesArray[0][1];
      }

      // --- COMPUTE LATEST NAV, DATE & YTD RETURN ---
      function computeLatestMetrics() {
        const lastPoint = navData[navData.length - 1];
        const lastTimestamp = lastPoint[0];    // ms since epoch
        const lastNav = lastPoint[1];

        // YTD start date (Jan 1 of current year)
        const now = new Date();
        const ytdStartDate = new Date(now.getFullYear(), 0, 1).getTime();
        const startNavYtd = getStartValue(navData, ytdStartDate);

        const ytdReturn = ((lastNav - startNavYtd) / startNavYtd) * 100;

        const lastDateObj = new Date(lastTimestamp);
        const lastDateStr = lastDateObj.toISOString().slice(0, 10); // YYYY-MM-DD

        return {
          lastNav,
          lastTimestamp,
          lastDateStr,
          ytdReturn
        };
      }

      // --- SEND LATEST NAV / DATE / YTD RETURN TO WIX PARENT PAGE ---
      function sendLatestNavToParent() {
        try {
          const metrics = computeLatestMetrics();

          // Send to parent (Wix page)
          window.parent.postMessage(
            {
              type: "MCI2_NAV_UPDATE",
              nav: metrics.lastNav,           // numeric NAV
              date: metrics.lastDateStr,      // "YYYY-MM-DD"
              timestamp: metrics.lastTimestamp,
              ytdReturn: metrics.ytdReturn    // numeric %, e.g. 12.34
            },
            "*"
          );
          console.log("Sent latest NAV/YTD to parent:", metrics);
        } catch (e) {
          console.error("Error sending NAV to parent:", e);
        }
      }

      function updateChart(startDate) {
        // MCI2 NAV start
        const startNav = getStartValue(navData, startDate);

        // S&P 500 Equal Weight start (if available)
        let startSp = null;
        if (typeof sp500EqualWeightCadData !== 'undefined' && sp500EqualWeightCadData.length) {
          startSp = getStartValue(sp500EqualWeightCadData, startDate);
        }

        // Rebuild MCI2 series with % change
        const updatedNavData = navData.map(point => ({
          x: point[0],
          y: point[1],
          change: ((point[1] - startNav) / startNav) * 100
        }));

        // Rebuild S&P EW series with % change (if present)
        let updatedSpData = [];
        if (startSp !== null) {
          updatedSpData = sp500EqualWeightCadData.map(point => ({
            x: point[0],
            y: point[1],
            change: ((point[1] - startSp) / startSp) * 100
          }));
        }

        // Update both series
        chart.series[0].setData(updatedNavData, false); // MCI2
        if (chart.series[1]) {
          chart.series[1].setData(updatedSpData, false); // S&P EW
        }
        chart.redraw();
      }

      const chart = Highcharts.stockChart('navChartContainer', {
        rangeSelector: {
          buttons: [
            {
              type: 'month',
              count: 1,
              text: '1m',
              events: {
                click: () => updateChart(new Date().setMonth(new Date().getMonth() - 1))
              }
            },
            {
              type: 'month',
              count: 3,
              text: '3m',
              events: {
                click: () => updateChart(new Date().setMonth(new Date().getMonth() - 3))
              }
            },
            {
              type: 'month',
              count: 6,
              text: '6m',
              events: {
                click: () => updateChart(new Date().setMonth(new Date().getMonth() - 6))
              }
            },
            {
              type: 'year',
              count: 1,
              text: '1yr',
              events: {
                click: () => updateChart(new Date().setFullYear(new Date().getFullYear() - 1))
              }
            },
            {
              type: 'ytd',
              text: 'YTD',
              events: {
                click: () => updateChart(new Date(new Date().getFullYear(), 0, 1))
              }
            },
            {
              type: 'all',
              text: 'ALL',
              events: {
                click: () => updateChart(navData[0][0])
              }
            }
          ],
          selected: 1
        },
        title: { text: 'Fund NAV Historical Performance vs S&P 500 Equal Weight (CAD)' },
        legend: {
          enabled: true
        },
        series: [
          {
            name: 'MCI2 NAV',
            type: 'line',
            data: navData.map(point => ({ x: point[0], y: point[1], change: 0 })),
            tooltip: {
              pointFormatter: function() {
                return `<span style="color:${this.series.color}">●</span> ` +
                       `MCI2 NAV: <b>${this.y.toFixed(2)}</b><br/>` +
                       `Change: <b>${this.change.toFixed(2)}%</b>`;
              },
              valueDecimals: 2
            },
            visible: true
          },
          {
            name: 'S&P 500 Equal Weight (CAD)',
            type: 'line',
            data: (typeof sp500EqualWeightCadData !== 'undefined' && sp500EqualWeightCadData.length
              ? sp500EqualWeightCadData.map(point => ({ x: point[0], y: point[1], change: 0 }))
              : []),
            tooltip: {
              pointFormatter: function() {
                return `<span style="color:${this.series.color}">●</span> ` +
                       `S&P 500 EW (CAD): <b>${this.y.toFixed(2)}</b><br/>` +
                       `Change: <b>${this.change.toFixed(2)}%</b>`;
              },
              valueDecimals: 2
            },
            visible: true
          }
        ],
        xAxis: {
          events: {
            afterSetExtremes: function (e) {
              if (e.min) {
                updateChart(e.min);
              }
            }
          }
        }
      });

      // Initial: YTD baseline for both series
      updateChart(new Date(new Date().getFullYear(), 0, 1));

      // Send latest NAV / date / YTD to Wix once everything is ready
      sendLatestNavToParent();
    });
  </script>
</body>
</html>
